name: "Org Coding Hours v9"
description: "Aggregate coding hours across multiple repositories via git-hours and publish a JSON report."
branding:
  icon: "clock"
  color: "purple"

inputs:
  workdir:
    description: "Path to the repository to analyse"
    required: false
    default: "."
  version:
    description: "git-hours package version to install (npm tag)"
    required: false
    default: "v1.5.0"

outputs:
  report-json:
    description: "Path to generated git-hours.json"
    value: "git-hours.json"

runs:
  using: "composite"
  steps:
    - uses: actions/setup-node@v3
      with:
        node-version: '14'

    - name: Install git-hours
      shell: bash
      run: |
        npm install -g git-hours@${{ inputs.version }} || {
          echo "Retrying with nodegit pre-install";
          npm install -g nodegit && npm install -g git-hours@${{ inputs.version }};
        }
        echo "$(npm bin -g)" >> "$GITHUB_PATH"

    - name: Generate coding hours report
      shell: bash
      env:
        WORKDIR: ${{ inputs.workdir }}
      run: |
        cd "$WORKDIR"
        git-hours > "$GITHUB_WORKSPACE/git-hours.json"
